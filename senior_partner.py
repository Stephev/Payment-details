# -*- coding:utf-8 -*-
# @Time    : 2020/9/11
# @Author  : Stephev
# @Site    : 
# @File    : senior_partner.py
# @Remarks :黄婷，匹配出买家代理的最近一级上级合伙人


import pymysql
import csv
import datetime
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.header import Header
import pandas as pd


now_time_r = datetime.datetime.now()
now_time = datetime.datetime.strftime(now_time_r,'%Y-%m-%d_%H_%M')
seniorpartner_xlsx = "E:\\csv_file\\"+now_time+"_匹配买家的上级合伙人.xlsx"


class cnMySQL:
    def __init__(self):
        self._dbhost = 'rm-bp1cim09l95sf67dplo.mysql.rds.aliyuncs.com'
        self._dbuser = 'python_dba'
        self._dbpassword = 'Python_dba1'
        self._dbname = 'prod_user'
        self._dbcharset = 'utf8'
        self._dbport = int(3306)
        self._conn = self.connectMySQL()

        if (self._conn):
            self._cursor = self._conn.cursor(cursor=pymysql.cursors.DictCursor)
    
    def connectMySQL(self):
        try:
            conn = pymysql.connect(host=self._dbhost,
                                   user=self._dbuser,
                                   passwd=self._dbpassword,
                                   db=self._dbname,
                                   port=self._dbport,
                                   cursorclass=pymysql.cursors.DictCursor,
                                   charset=self._dbcharset)
        except Exception as e:
            raise
            #print("数据库连接出错")
            conn = False
        return conn

    def close(self):
        if (self._conn):
            try:
                if (type(self._cursor) == 'object'):
                    self._conn.close()
                if (type(self._conn) == 'object'):
                    self._conn.close()
            except Exception:
                print("关闭数据库连接异常")

    def ExecQuery(self,sql,*args):
        """
        执行查询语句
        """
        res = ''
        if (self._conn):
            try:
                self._cursor.execute(sql,args)
                res = self._cursor.fetchall()
            except Exception:
                res = False
                print("查询异常")
            self.close()
        return res


def seniorPartner():
    """
    给出指定的的代理授权码，找出最近的合伙人代理名
    """
    conn = cnMySQL()
    proxy_code = ('XT123736','XT5527','XT2289','XT3149','XT127944','XT29735','XT3710','XT18881','XT8059','XT5078','XT53029','XT53740','XT1430','XT155727','XT126639','XT74323','XT1461','XT155073','XT155245','XT155325','XT2111','XT155253','XT123721','XT25262','XT155326','XT54247','XT25227','XT1390','XT124648','XT2766','XT2481','XT69398','XT1499','XT2356','XT7406','XT124084','XT10363','XT3870','XT1614','XT8887','XT125044','XT3943','XT3223','XT126833','XT2488','XT9034','XT155433','XT156107','XT124200','XT1813','XT1938','XT124279','XT124717','XT124530','XT124137','XT12413','XT32416','XT155313','XT123825','XT1254','XT124602','XT17798','XT2133','XT1242','XT124326','XT3381','XT7971','XT124034','XT4418','XT124632','XT75496','XT1961','XT5199','XT2861','XT123947','XT124628','XT3876','XT54264','XT5159','XT3869','XT15968','XT124027','XT59689','XT3727','XT3050','XT128721','XT27856','XT3048','XT7921','XT129575','XT54568','XT59311','XT4643','XT2333','XT15767','XT49659','XT147675','XT124423','XT124232','XT50849','XT124042','XT3629','XT124255','XT124204','XT1928','XT47194','XT3454','XT2491','XT1843','XT22878','XT3678','XT124447','XT3691','XT57955','XT57520','XT3352','XT3974','XT1391','XT8775','XT124583','XT1830','XT124256','XT15803','XT1259','XT113891','XT3450','XT155140','XT1368','XT3544','XT2043','XT3874','XT1545','XT52920','XT73552','XT5318','XT104411','XT1854','XT2335','XT123995','XT124420','XT2385','XT124597','XT5166','XT81252','XT124344','XT24199','XT3284','XT3880','XT155272','XT79296','XT1983','XT107232','XT126561','XT155523','XT123684','XT124257','XT155287','XT128728','XT2678','XT54290','XT75584','XT1794','XT2190','XT155933','XT123916','XT124952','XT124205','XT124272','XT124463','XT155461','XT3204','XT155581','XT155069','XT125860','XT124630','XT1350','XT2377','XT155880','XT128250','XT69426','XT3023','XT20631','XT45133','XT3605','XT2676','XT8731','XT53007','XT129920','XT156325','XT20756','XT17709','XT3857','XT29130','XT3187','XT3201','XT3200','XT156414','XT126983','XT3868','XT28134','XT3186','XT129796','XT2998','XT110023','XT8974','XT2153','XT17269','XT2871','XT1554','XT124444','XT10901','XT2745','XT124633','XT123823','XT3206','XT51371','XT128599','XT23843','XT124430','XT146779','XT3413','XT2882','XT3828','XT2021','XT155856','XT2880','XT60890','XT6773','XT156487','XT1977','XT2072','XT3203','XT2812','XT3041','XT84953','XT3444','XT7839','XT2159','XT123900','XT2595','XT124737','XT2993','XT61066','XT123962','XT11631','XT2669','XT3366','XT2034','XT8042','XT128581','XT121467','XT155035','XT156544','XT124951','XT155467','XT155247','XT2771','XT3708','XT18093','XT1354','XT43585','XT1831','XT123941','XT16724','XT82410','XT3623','XT2228','XT2915','XT2881','XT155133','XT124476','XT129357','XT124274','XT1459','XT3632','XT7830','XT155799','XT54442','XT53613','XT3676','XT4826','XT1410','XT19611','XT44686','XT3609','XT124667','XT3808','XT124526','XT2160','XT21438','XT2942','XT2632','XT125231','XT47833','XT2169','XT8076','XT3724','XT156272','XT156591','XT2831','XT50479','XT1357','XT124958','XT1456','XT3879','XT2504','XT155797','XT57517','XT128232','XT129410','XT2061','XT1400','XT124758','XT23705','XT3360','XT4121','XT155996','XT2671','XT23617','XT10087','XT3391','XT1441','XT2503','XT124716','XT128080','XT156074','XT23101','XT1603','XT3026','XT5254','XT45696','XT77059','XT4849','XT125041','XT124088','XT155611','XT3051','XT155610','XT128627','XT1504','XT127689','XT123881','XT2129','XT1832','XT2607','XT1333','XT124661','XT3886','XT123860','XT2340','XT124325','XT3059','XT3387','XT3061','XT3329','XT2913','XT3424','XT3834','XT156564','XT53008','XT156462','XT2753','XT3453','XT1988','XT1332','XT45139','XT1471','XT3279','XT5558','XT5240','XT156444','XT155602','XT155645','XT124449','XT34971','XT22460','XT14493','XT25067','XT2661','XT43522','XT155607','XT70794','XT146981','XT155400','XT25596','XT2886','XT2999','XT47065','XT4913','XT155095','XT3455','XT155487','XT3848','XT155854','XT1454','XT155250','XT1800','XT147308','XT1358','XT3035','XT1250','XT1649','XT42469','XT45909','XT124513','XT49717','XT2101','XT155649','XT58028','XT5305','XT124849','XT138383','XT124277','XT124725','XT3434','XT9286','XT3712','XT1440','XT7807','XT147326','XT59937','XT54466','XT123832','XT12899','XT16851','XT1353','XT20018','XT16926','XT124217','XT1511','XT3817','XT1395','XT2368','XT129079','XT46887','XT3899','XT155100','XT105233','XT3426','XT21239','XT21152','XT21429','XT124231','XT124237','XT5226','XT5038','XT124744','XT8408','XT1972','XT12301','XT125108','XT3039','XT124055','XT2380','XT3875','XT1887','XT12885','XT129285','XT124704','XT8002','XT9907','XT3709','XT146734','XT3030','XT155855','XT3029','XT1417','XT155796','XT14009','XT124252','XT3208','XT155567','XT53097','XT155619','XT124128','XT8873','XT147249','XT7225','XT23075','XT128157','XT3412','XT123672','XT155255','XT13169','XT124064','XT2857','XT58117','XT1593','XT53154','XT28032','XT16922','XT9232','XT1975','XT19120','XT124029','XT3185','XT2916','XT107412','XT2260','XT3578','XT156157','XT2367','XT124243','XT12049','XT3028','XT1543','XT53394','XT37536','XT141323','XT3673','XT2750','XT155281','XT9239','XT156367','XT3729','XT3951','XT2969','XT3948','XT3199','XT125330','XT30935','XT34142','XT2747','XT1968','XT2454','XT1500','XT128544','XT128099','XT128561','XT2185','XT156187','XT2381','XT124297','XT2109','XT124319','XT3464','XT3825','XT3017','XT156344','XT151653','XT139193','XT124043','XT155805','XT3599','XT124467','XT155525','XT124143','XT1963','XT50905','XT123828','XT1281','XT6169','XT156587','XT58601','XT2909','XT16595','XT3927','XT3046','XT2819','XT156521','XT147293','XT12432','XT123552','XT124254','XT124466','XT3105','XT1463','XT124229','XT155691','XT45758','XT7214','XT15992','XT9971','XT3337','XT155267','XT155942','XT124322','XT2375','XT3205','XT3240','XT7085','XT123842','XT123789','XT123723','XT3016','XT4120','XT2197','XT2492','XT2293','XT8367','XT2781','XT59680','XT11238','XT46038','XT2922','XT28619','XT155103','XT50098','XT3926','XT2113','XT155838','XT3726','XT2005','XT124739','XT124276','XT39226','XT124960','XT123724','XT2572','XT155081','XT155638','XT155601','XT1982','XT135236','XT3856','XT1474','XT156520','XT28533','XT15244','XT1559','XT124605','XT2331','XT124821','XT156676','XT3144','XT155431','XT57599','XT2843','XT155791','XT3007','XT1850','XT156475','XT3446','XT1853','XT9737','XT3580','XT15424','XT124223','XT124251','XT53302','XT123946','XT3354','XT2746','XT54721','XT11928','XT1298','XT18919','XT155128','XT124216','XT2102','XT155734','XT2873','XT125705','XT2154','XT2773','XT1836','XT155753','XT126178','XT155837','XT123912','XT155457','XT3461','XT60281','XT1481','XT7371','XT124139','XT56159','XT3326','XT5712','XT2346','XT3545','XT13067','XT12823','XT9077','XT3867','XT156158','XT24322','XT5267','XT13531','XT1879','XT2117','XT3339','XT2372','XT155903','XT2032','XT60513','XT14287','XT156180','XT9843','XT155524','XT2390','XT155446','XT2177','XT29268','XT124462','XT123555','XT6914','XT124263','XT2778','XT156543','XT3929','XT3451','XT3865','XT123917','XT2035','XT155676','XT29582','XT3928','XT156208','XT124452','XT128247','XT123932','XT4003','XT128199','XT10994','XT4446','XT155068','XT124636','XT24719','XT156405','XT7655','XT3704','XT47750','XT134970','XT31612','XT2941','XT3649','XT155965','XT156599','XT124405','XT155328','XT123851','XT3832','XT54263','XT59913','XT6204','XT155488','XT124265','XT3429','XT124558','XT154912','XT2821','XT124963','XT124943','XT2899','XT155347','XT124702','XT155380','XT3598','XT47435','XT11953','XT3648','XT124700','XT63662','XT3036','XT1342','XT27434','XT124304','XT15117','XT3847','XT125110','XT15410','XT130768','XT1995','XT3445','XT44117','XT129006','XT2879','XT1981','XT1551','XT3777','XT155392','XT1385','XT3962','XT124041','XT3399','XT3884','XT7081','XT155650','XT7012','XT9661','XT125197','XT102771','XT1973','XT12152','XT1356','XT141827','XT1388','XT127159','XT21316','XT155282','XT123927','XT155405','XT155870','XT126734','XT124843','XT2758','XT124457','XT20136','XT16760','XT123925','XT4974','XT57981','XT124224','XT3435','XT2144','XT4241','XT2251','XT14225','XT155554','XT23030','XT42348','XT155271','XT156103','XT124426','XT156505','XT30634','XT8546','XT3830','XT124559','XT155005','XT124025','XT1258','XT3872','XT19924','XT3764','XT1455','XT2738','XT7053','XT2339','XT3586','XT3253','XT128563','XT1849','XT135433','XT147368','XT6049','XT123850','XT2917','XT21733','XT5034','XT1855','XT3438','XT1347','XT3833','XT124331','XT2200','XT3239','XT124245','XT7265','XT128788','XT1349','XT155911','XT3209','XT129243','XT1922','XT125058','XT1496','XT54358','XT156612','XT124569','XT2341','XT3049','XT123700','XT156573','XT4156','XT15123','XT125139','XT3274','XT124582','XT2349','XT128746','XT2359','XT125063','XT2149','XT2325','XT156502','XT1777','XT35899','XT155072','XT1526','XT3448','XT3022','XT1625','XT1433','XT77751','XT2230','XT124262','XT2059','XT1914','XT68403','XT124260','XT124236','XT129757','XT155618','XT129744','XT155953','XT155863','XT155377','XT10257','XT123852','XT155773','XT155137','XT1335','XT124751','XT124762','XT2842','XT3785','XT17616','XT124222','XT1389','XT42564','XT155806','XT138587','XT155067','XT4195','XT19208','XT3250','XT155629','XT28048','XT124258','XT3740','XT2382','XT28678','XT9852','XT129271','XT3173','XT124282','XT68797','XT93194','XT6561','XT9371','XT124404','XT2155','XT124593','XT2242','XT3878','XT156050','XT156484','XT4877','XT18542','XT21029','XT155665','XT75109','XT155297','XT156527','XT1405','XT128677','XT3043','XT124572','XT156605','XT3966','XT24503','XT155257','XT24260','XT3456','XT1414','XT124253','XT125193','XT3189','XT19671','XT124949','XT124046','XT11514','XT1827','XT30947','XT8760','XT155819','XT3324','XT58016','XT1842','XT3877','XT77331','XT124453','XT1538','XT3188','XT147303','XT155918','XT155478','XT125444','XT1344','XT2502','XT3423','XT3452','XT1416','XT155429','XT156584','XT3237','XT4044','XT2134','XT155430','XT2286','XT26472','XT3780','XT124443','XT50139','XT2287','XT143056','XT123776','XT1845','XT155526','XT3147')
    #proxy_code =  ('XT123736','XT5527','XT2289','XT3149','XT127944','XT29735','XT3710','XT18881','XT8059','XT5078','XT53029','XT53740','XT1430','XT155727','XT126639','XT74323','XT1461','XT155073','XT155245')
    final_rows = []
    for i in proxy_code:
        print(i)
        p_info = conn.ExecQuery("select id,name as self_name,level_id self_level_id,auth_code,ref_id from renren_distributor where auth_code = %s;",i)
        #print(p_info)
        while_id = p_info[0]["ref_id"]
        #print(while_id)
        while True:
            proxy_info  =  conn.ExecQuery("select id,level_id,ref_id from renren_distributor where id = %s;",while_id)
            print(proxy_info)
            p_id =  proxy_info[0]["id"]
            p_levelid = proxy_info[0]["level_id"]
            pro_id = proxy_info[0]["ref_id"]
            if p_levelid in (1,2):
                ref_name =  conn.ExecQuery("select name,level_id from renren_distributor where  id = %s;",p_id)
                #print(ref_name)
                p_info[0].update(ref_name[0])
                #print(p_info)a
                final_rows.extend(p_info)
                break
            while_id = pro_id
    #print(final_rows)
    headers = ['id','self_name','level_id','self_level_id','auth_code','ref_id','name','level_id']
    dt = pd.DataFrame(final_rows,columns=headers)
    dt.to_excel(seniorpartner_xlsx,index=0)
    return


def main():
    seniorPartner()
    return

if __name__ == '__main__':
    main()


